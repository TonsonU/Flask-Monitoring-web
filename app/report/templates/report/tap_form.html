<!--
####################################################
# Flask Monitoring Web
#
# 
# Project : Python, Flask, MySQLite, Bootstrap
# Author  : Thanapoom Sukarin
# Modifier: 
# Version : 
# Date    : Dec 01, 2024
#
####################################################
-->

{% import "bootstrap/wtf.html" as wtf %}
{% extends "layout.html" %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interlocking Report Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container py-4">
    <h2>TAP Report Form</h2>
    <form method="POST" action="{{ url_for('report.generate_tap_pdf') }}">
        <label>Date:</label><input type="text" name="date"><br>
        <label>Work Order No:</label><input type="text" name="work_order"><br>
        <label>Work Type :</label><input type="text" name="work_type"><br>
        <label>Location:</label><input type="text" name="loation"><br>
        <label>Track Possession No:</label><input type="text" name="track_no"><br>
        <label>Apostle Name:</label>
        <select name="apostle" id="apostle_select">
            <option value="">-- กรุณาเลือก --</option>
        </select><br>
    
        <!-- ✅ มีการเปลี่ยน Unit หรือไม่ -->
        <label>มีการเปลี่ยน Unit หรือไม่:</label>
        <select id="change_unit" name="change_unit" onchange="toggleUnitSection()">
            <option value="no">ไม่มี</option>
            <option value="yes">มี</option>
        </select><br>
    
        <!-- ✅ ถ้ามีการเปลี่ยน ให้เลือกจำนวน -->
        <div id="unit_count_section" style="display: none;">
            <label>มีกี่รายการที่เปลี่ยน:</label>
            <select id="unit_count" onchange="toggleUnitFields()">
                <option value="1">1 ชิ้น</option>
                <option value="2">2 ชิ้น</option>
                <option value="3">3 ชิ้น</option>
            </select><br>
        </div>
    
        <!-- ✅ กลุ่ม Unit ที่จะซ่อนได้ -->
        <div id="unit_fields">
            <div id="unit_1" style="display:none;">
                <label>Unit No.1:</label><input type="text" name="unit_name_1"><br>
                <label>Serial Installed No.1:</label><input type="text" name="sn_installed_1"><br>
                <label>Serial Removed No.1:</label><input type="text" name="sn_removed_1"><br>
                <label>Qty No.1:</label><input type="text" name="qty_1"><br>
            </div>
            <div id="unit_2" style="display:none;">
                <label>Unit No.2:</label><input type="text" name="unit_name_2"><br>
                <label>Serial Installed No.2:</label><input type="text" name="sn_installed_2"><br>
                <label>Serial Removed No.2:</label><input type="text" name="sn_removed_2"><br>
                <label>Qty No.2:</label><input type="text" name="qty_2"><br>
            </div>
            <div id="unit_3" style="display:none;">
                <label>Unit No.3:</label><input type="text" name="unit_name_3"><br>
                <label>Serial Installed No.3:</label><input type="text" name="sn_installed_3"><br>
                <label>Serial Removed No.3:</label><input type="text" name="sn_removed_3"><br>
                <label>Qty No.3:</label><input type="text" name="qty_3"><br>
            </div>
        </div>
    
        <hr>
        <label>จำนวนผู้ปฏิบัติงาน:</label>
    <select id="person_count" onchange="togglePersonFields()">
        <option value="1">1 คน</option>
        <option value="2">2 คน</option>
        <option value="3">3 คน</option>
        <option value="4">4 คน</option>
        <option value="5">5 คน</option>
        <option value="6">6 คน</option>
        <option value="7">7 คน</option>
        <option value="8">8 คน</option>
        <option value="9">9 คน</option>
        <option value="10">10 คน</option>
    </select><br><br>

    <!-- ✅ รายชื่อผู้ปฏิบัติงาน -->
    <div id="person_fields">
        <!-- จะถูกสร้างด้วย JavaScript -->
    </div>
    
        <label>Maintenance Action:</label><input type="text" name="maintenance_action"><br>
    
        <button type="submit">สร้าง PDF</button>
    </form>
    <script>
        const people = [
          "นายกิตติคุณ วัฒนานันท์",
          "นายชัชวาล ธรรมสอน",
          "นายสมชาย เข็มทอง",
          "นางสาวปิยะนุช คำภา",
          "นางสาวอรวรรณ พึ่งบุญ",
          "นายธนพล ใจดี",
          "นายจิรายุทธ นาคดี",
          "นางสาวชนิกานต์ ปรีดา",
          "นายอภิสิทธิ์ นาวารัตน์",
          "นางสุรีย์พร พิมพ์ไทย"
        ];
      
        function populateApostleDropdown() {
          const apostleSelect = document.getElementById("apostle_select");
          if (!apostleSelect) return;
          apostleSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
          for (const name of people) {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            apostleSelect.appendChild(option);
          }
        }
      
        function toggleUnitSection() {
          const changeUnit = document.getElementById('change_unit').value;
          const unitCountSection = document.getElementById('unit_count_section');
          if (changeUnit === 'yes') {
            unitCountSection.style.display = 'block';
            toggleUnitFields();
          } else {
            unitCountSection.style.display = 'none';
            for (let i = 1; i <= 3; i++) {
              document.getElementById('unit_' + i).style.display = 'none';
              document.querySelector(`[name="unit_name_${i}"]`).value = '-';
              document.querySelector(`[name="sn_installed_${i}"]`).value = '-';
              document.querySelector(`[name="sn_removed_${i}"]`).value = '-';
              document.querySelector(`[name="qty_${i}"]`).value = '-';
            }
          }
        }
      
        function toggleUnitFields() {
          const count = parseInt(document.getElementById('unit_count').value);
          for (let i = 1; i <= 3; i++) {
            const section = document.getElementById('unit_' + i);
            if (i <= count) {
              section.style.display = 'block';
              document.querySelector(`[name="unit_name_${i}"]`).value = '';
              document.querySelector(`[name="sn_installed_${i}"]`).value = '';
              document.querySelector(`[name="sn_removed_${i}"]`).value = '';
              document.querySelector(`[name="qty_${i}"]`).value = '';
            } else {
              section.style.display = 'none';
              document.querySelector(`[name="unit_name_${i}"]`).value = '-';
              document.querySelector(`[name="sn_installed_${i}"]`).value = '-';
              document.querySelector(`[name="sn_removed_${i}"]`).value = '-';
              document.querySelector(`[name="qty_${i}"]`).value = '-';
            }
          }
        }
      
        function togglePersonFields() {
          const count = parseInt(document.getElementById('person_count').value);
          for (let i = 1; i <= 10; i++) {
            const field = document.getElementById('person_' + i);
            if (i <= count) {
              field.style.display = 'block';
            } else {
              field.style.display = 'none';
              const select = document.querySelector(`[name="person_${i}"]`);
              if (select) select.value = '';
            }
          }
          updateAllDropdowns();
        }
      
        function getSelectedValues() {
          const values = [];
          for (let i = 1; i <= 10; i++) {
            const select = document.querySelector(`[name="person_${i}"]`);
            if (select && select.value) {
              values.push(select.value);
            }
          }
          return values;
        }
      
        function generateOptions(selectedValue) {
          let options = '<option value="">-- กรุณาเลือก --</option>';
          for (const name of people) {
            const isSelected = name === selectedValue ? " selected" : "";
            options += `<option value="${name}"${isSelected}>${name}</option>`;
          }
          return options;
        }
      
        function updateAllDropdowns() {
          const selected = getSelectedValues();
          for (let i = 1; i <= 10; i++) {
            const select = document.querySelector(`[name="person_${i}"]`);
            if (!select || select.closest("div").style.display === "none") continue;
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
            for (const name of people) {
              if (selected.includes(name) && name !== currentValue) continue;
              const option = document.createElement("option");
              option.value = name;
              option.text = name;
              if (name === currentValue) option.selected = true;
              select.appendChild(option);
            }
          }
        }
      
        document.addEventListener("DOMContentLoaded", function () {
          const container = document.getElementById("person_fields");
          for (let i = 1; i <= 10; i++) {
            const div = document.createElement("div");
            div.id = "person_" + i;
            div.style.display = i === 1 ? "block" : "none";
      
            const label = document.createElement("label");
            label.textContent = `Person No.${i}:`;
      
            const select = document.createElement("select");
            select.name = `person_${i}`;
            select.dataset.index = i;
            select.innerHTML = generateOptions("");
            select.addEventListener("change", updateAllDropdowns);
      
            div.appendChild(label);
            div.appendChild(select);
            div.appendChild(document.createElement("br"));
            container.appendChild(div);
          }
      
          // 🔁 เรียกใช้ตอนโหลดหน้า
          populateApostleDropdown();
          toggleUnitSection();
          togglePersonFields();
        });
      </script>

{% endblock %}